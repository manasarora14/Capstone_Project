using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using ServiceManagementApi.Data;
using System.Security.Claims;
using ServiceManagementApi.Services; // Ensure this matches your Service folder namespace
namespace ServiceManagementApi.Controllers;


[Route("api/[controller]")]
[ApiController]
[Authorize]
public class BillingController : ControllerBase
{
    private readonly IBillingService _billingService;

    public BillingController(IBillingService billingService)
    {
        _billingService = billingService;
    }

    [HttpGet("my-invoices")]
    public async Task<IActionResult> GetMyInvoices()
    {
        var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
        var userRole = User.FindFirstValue(ClaimTypes.Role);

        var invoices = await _billingService.GetInvoicesAsync(userId!, userRole!);
        return Ok(invoices);
    }

    [HttpPost("pay/{invoiceId}")]
    public async Task<IActionResult> PayInvoice(int invoiceId)
    {
        var success = await _billingService.PayInvoiceAsync(invoiceId);
        if (!success) return NotFound();
        return Ok(new { message = "Payment successful!" });
    }
}