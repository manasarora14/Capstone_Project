using Microsoft.EntityFrameworkCore;
using ServiceManagementApi.Data;
using ServiceManagementApi.DTOs;
using ServiceManagementApi.Models;

namespace ServiceManagementApi.Services;

public interface ITechnicianService
{
    Task<TechnicianAvailabilityResponseDto> AddAvailabilityAsync(AvailabilityDto dto);
    Task<bool> RemoveAvailabilityAsync(int id, string technicianId);
    Task<List<TechnicianAvailabilityResponseDto>> GetAvailabilityAsync(string technicianId);

    // Scheduling
    Task<bool> ScheduleVisitAsync(ScheduleVisitDto dto);
}

public class TechnicianService : ITechnicianService
{
    private readonly ApplicationDbContext _context;

    public TechnicianService(ApplicationDbContext context)
    {
        _context = context;
    }

    public async Task<TechnicianAvailabilityResponseDto> AddAvailabilityAsync(AvailabilityDto dto)
    {
        if (dto.EndUtc <= dto.StartUtc) throw new ArgumentException("End must be after start");

        var avail = new TechnicianAvailability
        {
            TechnicianId = dto.TechnicianId,
            StartUtc = dto.StartUtc,
            EndUtc = dto.EndUtc
        };
        _context.TechnicianAvailabilities.Add(avail);
        await _context.SaveChangesAsync();

        return new TechnicianAvailabilityResponseDto
        {
            Id = avail.Id,
            TechnicianId = avail.TechnicianId,
            StartUtc = avail.StartUtc,
            EndUtc = avail.EndUtc
        };
    }

    public async Task<bool> RemoveAvailabilityAsync(int id, string technicianId)
    {
        var avail = await _context.TechnicianAvailabilities.FindAsync(id);
        if (avail == null || avail.TechnicianId != technicianId) return false;
        _context.TechnicianAvailabilities.Remove(avail);
        await _context.SaveChangesAsync();
        return true;
    }

    public async Task<List<TechnicianAvailabilityResponseDto>> GetAvailabilityAsync(string technicianId)
    {
        return await _context.TechnicianAvailabilities
            .Where(a => a.TechnicianId == technicianId)
            .OrderBy(a => a.StartUtc)
            .Select(a => new TechnicianAvailabilityResponseDto { Id = a.Id, TechnicianId = a.TechnicianId, StartUtc = a.StartUtc, EndUtc = a.EndUtc })
            .ToListAsync();
    }

    public async Task<bool> ScheduleVisitAsync(ScheduleVisitDto dto)
    {
        // 1. Confirm availability window exists that covers the scheduled time
        var availExists = await _context.TechnicianAvailabilities
            .AnyAsync(a => a.TechnicianId == dto.TechnicianId && a.StartUtc <= dto.ScheduledUtc && a.EndUtc >= dto.ScheduledUtc);

        if (!availExists) return false;

        // 2. Check technician not already booked for that time (conflict with other service requests)
        var conflict = await _context.ServiceRequests
            .AnyAsync(r => r.TechnicianId == dto.TechnicianId && r.ScheduledDate == dto.ScheduledUtc && r.Status != RequestStatus.Completed);

        if (conflict) return false;

        // 3. Assign the technician and update status to Assigned
        var request = await _context.ServiceRequests.FindAsync(dto.ServiceRequestId);
        if (request == null) return false;

        request.TechnicianId = dto.TechnicianId;
        request.Status = RequestStatus.Assigned;
        request.ScheduledDate = dto.ScheduledUtc;

        await _context.SaveChangesAsync();
        return true;
    }
}
