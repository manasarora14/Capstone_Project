using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Moq;
using Microsoft.AspNetCore.Identity;
using ServiceManagementApi.Controllers;
using ServiceManagementApi.DTOs;
using ServiceManagementApi.Services;
using Xunit;

namespace ServiceManagementApi.Tests.Controllers
{
    public class AuthControllerTests
    {
        [Fact]
        public async Task Register_ReturnsOk_WhenUserCreated()
        {
            var mockService = new Mock<IAuthService>();
            mockService.Setup(s => s.RegisterAsync(It.IsAny<RegisterDto>())).ReturnsAsync(IdentityResult.Success);

            var controller = new AuthController(mockService.Object);
            var dto = new RegisterDto { Email = "a@b.com", Password = "P@ssw0rd" };

            var result = await controller.Register(dto);
            Assert.IsType<OkObjectResult>(result);
        }

        [Fact]
        public async Task Login_ReturnsOk_WithToken()
        {
            var mockService = new Mock<IAuthService>();
            mockService.Setup(s => s.LoginAsync(It.IsAny<LoginDto>())).ReturnsAsync(new AuthResponseDto { Token = "token", Email = "a@b.com", Role = "Customer" });

            var controller = new AuthController(mockService.Object);
            var dto = new LoginDto { Email = "a@b.com", Password = "P@ssw0rd" };

            var result = await controller.Login(dto);
            var ok = Assert.IsType<OkObjectResult>(result);
            var resp = Assert.IsType<AuthResponseDto>(ok.Value);
            Assert.Equal("token", resp.Token);
        }
    }
}
